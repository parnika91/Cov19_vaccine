---
title: "Cell-cell interactions with CellChat"
output:
  html_document:
    df_print: paged
  pdf_document: default
---
## Cell-cell interactions for in vitro COVID-19 vaccinated samples - comparative analysis

```{r setup, include=FALSE}
#knitr::opts_chunk$set(dev = 'pdf')
```


```{r load_libraries, echo = F}
# libraries
#devtools::install_github("sqjin/CellChat")
#devtools::install_github("thomasp85/patchwork")

suppressPackageStartupMessages(library(CellChat))
suppressPackageStartupMessages(library(patchwork))
suppressPackageStartupMessages(library(ComplexHeatmap))
suppressPackageStartupMessages(library(circlize))
suppressPackageStartupMessages(library(RColorBrewer))
suppressPackageStartupMessages(library(svglite))
suppressPackageStartupMessages(library(NMF))
suppressPackageStartupMessages(library(ggalluvial))
suppressPackageStartupMessages(library(tidyverse))

#library(pheatmap)
options(stringsAsFactors = FALSE)
#options(bitmapType="cairo")
```

```{r load_objects_from_all_conditions_and_basic_operations, echo = F}

Ctrl.7 <- readRDS("~/Documents/charite/Sophia/cellchat_7h_Ctrl.rds") %>%
  computeCommunProbPathway() %>%
  aggregateNet() %>%
  netAnalysis_computeCentrality(., slot.name = "netP")

AZD.7 <- readRDS("~/Documents/charite/Sophia/cellchat_7h_AZD.rds") %>%
  computeCommunProbPathway() %>%
  aggregateNet() %>%
  netAnalysis_computeCentrality(., slot.name = "netP")

BNT.7 <- readRDS("~/Documents/charite/Sophia/cellchat_7h_BNT.rds") %>%
  computeCommunProbPathway() %>%
  aggregateNet() %>%
  netAnalysis_computeCentrality(., slot.name = "netP")


Ctrl.18 <- readRDS("~/Documents/charite/Sophia/cellchat_18h_Ctrl.rds") %>%
  computeCommunProbPathway() %>%
  aggregateNet() %>%
  netAnalysis_computeCentrality(., slot.name = "netP")

AZD.18 <- readRDS("~/Documents/charite/Sophia/cellchat_18h_AZD.rds") %>%
  computeCommunProbPathway() %>%
  aggregateNet() %>%
  netAnalysis_computeCentrality(., slot.name = "netP")

BNT.18 <- readRDS("~/Documents/charite/Sophia/cellchat_18h_BNT.rds") %>%
  computeCommunProbPathway() %>%
  aggregateNet() %>%
  netAnalysis_computeCentrality(., slot.name = "netP")

```

```{r plot_interaction_number_and_strength, echo = F, dpi = 300}

# Ctrl.7
groupSize <- as.numeric(table(Ctrl.7@idents))
par(mfrow = c(1,2), xpd=TRUE)
netVisual_circle(Ctrl.7@net$count, vertex.weight = groupSize, weight.scale = T, label.edge= F, title.name = "Ctrl(7h) Number of interactions")
netVisual_circle(Ctrl.7@net$weight, vertex.weight = groupSize, weight.scale = T, label.edge= F, title.name = "Ctrl(7h) Interaction weights/strength")

# AZD.7
groupSize <- as.numeric(table(AZD.7@idents))
par(mfrow = c(1,2), xpd=TRUE)
netVisual_circle(AZD.7@net$count, vertex.weight = groupSize, weight.scale = T, label.edge= F, title.name = "AZD(7h) Number of interactions")
netVisual_circle(AZD.7@net$weight, vertex.weight = groupSize, weight.scale = T, label.edge= F, title.name = "AZD(7h) Interaction weights/strength")

# BNT.7
groupSize <- as.numeric(table(BNT.7@idents))
par(mfrow = c(1,2), xpd=TRUE)
netVisual_circle(BNT.7@net$count, vertex.weight = groupSize, weight.scale = T, label.edge= F, title.name = "BNT(7h) Number of interactions")
netVisual_circle(BNT.7@net$weight, vertex.weight = groupSize, weight.scale = T, label.edge= F, title.name = "BNT(7h) Interaction weights/strength")

# Ctrl.18
groupSize <- as.numeric(table(Ctrl.18@idents))
par(mfrow = c(1,2), xpd=TRUE)
netVisual_circle(Ctrl.18@net$count, vertex.weight = groupSize, weight.scale = T, label.edge= F, title.name = "Ctrl(18h) Number of interactions")
netVisual_circle(Ctrl.18@net$weight, vertex.weight = groupSize, weight.scale = T, label.edge= F, title.name = "Ctrl(18h) Interaction weights/strength")

# AZD.18
groupSize <- as.numeric(table(AZD.18@idents))
par(mfrow = c(1,2), xpd=TRUE)
netVisual_circle(AZD.18@net$count, vertex.weight = groupSize, weight.scale = T, label.edge= F, title.name = "AZD(18h) Number of interactions")
netVisual_circle(AZD.18@net$weight, vertex.weight = groupSize, weight.scale = T, label.edge= F, title.name = "AZD(18h) Interaction weights/strength")

# BNT.18
groupSize <- as.numeric(table(BNT.18@idents))
par(mfrow = c(1,2), xpd=TRUE)
netVisual_circle(BNT.18@net$count, vertex.weight = groupSize, weight.scale = T, label.edge= F, title.name = "BNT(18h) Number of interactions")
netVisual_circle(BNT.18@net$weight, vertex.weight = groupSize, weight.scale = T, label.edge= F, title.name = "BNT(18h) Interaction weights/strength")

```

```{r interactions_from_individual_celltype, echo = F, warning=FALSE, fig.dim=c(10,10),dpi = 300}

mat <- Ctrl.7@net$weight
par(mfrow = c(3,4), xpd=TRUE)
# layout(matrix(c(1,1,2,2,3,3,4,4,
#                 1,1,2,2,3,3,4,4,
#                 5,5,6,6,7,7,8,8,
#                 5,5,6,6,7,7,8,8,
#                 9,9,10,10,11,11,12,12,
#                 9,9,10,10,11,11,12,12), nrow = 6, ncol = 8, byrow = TRUE))
#layout.show(12)
for (i in 1:nrow(mat)) {
  mat2 <- matrix(0, nrow = nrow(mat), ncol = ncol(mat), dimnames = dimnames(mat))
  mat2[i, ] <- mat[i, ]
  netVisual_circle(mat2, vertex.weight = as.numeric(table(Ctrl.7@idents)), weight.scale = T, edge.weight.max = max(mat), title.name = paste0("Ctrl 7h ", rownames(mat)[i], collapse = ''))
}

mat <- AZD.7@net$weight
par(mfrow = c(3,4), xpd=TRUE)
for (i in 1:nrow(mat)) {
  mat2 <- matrix(0, nrow = nrow(mat), ncol = ncol(mat), dimnames = dimnames(mat))
  mat2[i, ] <- mat[i, ]
  netVisual_circle(mat2, vertex.weight = as.numeric(table(AZD.7@idents)), weight.scale = T, edge.weight.max = max(mat), title.name = paste0("AZD 7h ", rownames(mat)[i], collapse = ''))
}

mat <- BNT.7@net$weight
par(mfrow = c(3,4), xpd=TRUE)
for (i in 1:nrow(mat)) {
  mat2 <- matrix(0, nrow = nrow(mat), ncol = ncol(mat), dimnames = dimnames(mat))
  mat2[i, ] <- mat[i, ]
  netVisual_circle(mat2, vertex.weight = as.numeric(table(BNT.7@idents)), weight.scale = T, edge.weight.max = max(mat), title.name = paste0("BNT 7h ", rownames(mat)[i], collapse = ''))
}


mat <- Ctrl.18@net$weight
par(mfrow = c(3,4), xpd=TRUE)
for (i in 1:nrow(mat)) {
  mat2 <- matrix(0, nrow = nrow(mat), ncol = ncol(mat), dimnames = dimnames(mat))
  mat2[i, ] <- mat[i, ]
  netVisual_circle(mat2, vertex.weight = as.numeric(table(Ctrl.18@idents)), weight.scale = T, edge.weight.max = max(mat), title.name = paste0("Ctrl 18h ", rownames(mat)[i], collapse = ''))
}

mat <- AZD.18@net$weight
par(mfrow = c(3,4), xpd=TRUE)
for (i in 1:nrow(mat)) {
  mat2 <- matrix(0, nrow = nrow(mat), ncol = ncol(mat), dimnames = dimnames(mat))
  mat2[i, ] <- mat[i, ]
  netVisual_circle(mat2, vertex.weight = as.numeric(table(AZD.18@idents)), weight.scale = T, edge.weight.max = max(mat), title.name = paste0("AZD 18h ", rownames(mat)[i], collapse = ''))
}

mat <- BNT.18@net$weight
par(mfrow = c(3,4), xpd=TRUE)
for (i in 1:nrow(mat)) {
  mat2 <- matrix(0, nrow = nrow(mat), ncol = ncol(mat), dimnames = dimnames(mat))
  mat2[i, ] <- mat[i, ]
  netVisual_circle(mat2, vertex.weight = as.numeric(table(BNT.18@idents)), weight.scale = T, edge.weight.max = max(mat), title.name = paste0("BNT 18h ", rownames(mat)[i], collapse = ''))
}
```

```{r net.df, echo = F}

Ctrl.7.net <- subsetCommunication(Ctrl.7)
Ctrl.7.net.p <- subsetCommunication(Ctrl.7, slot.name = "netP")

AZD.7.net <- subsetCommunication(AZD.7)
AZD.7.net.p <- subsetCommunication(AZD.7, slot.name = "netP")

BNT.7.net <- subsetCommunication(BNT.7)
BNT.7.net.p <- subsetCommunication(BNT.7, slot.name = "netP")


Ctrl.18.net <- subsetCommunication(Ctrl.18)
Ctrl.18.net.p <- subsetCommunication(Ctrl.18, slot.name = "netP")

AZD.18.net <- subsetCommunication(AZD.18)
AZD.18.net.p <- subsetCommunication(AZD.18, slot.name = "netP")

BNT.18.net <- subsetCommunication(BNT.18)
BNT.18.net.p <- subsetCommunication(BNT.18, slot.name = "netP")
```

```{r LR_chord, warning=F, message = F, echo = F, dpi = 300}

# Ctrl.7
pathways.show <- c("CCL", "ICAM", "ITGB2", "BAFF", "ADGRE5", 
                   "TGFb", "CD22", "CD45", "IL16", "TNF", 
                   "CXCL", "CD96", "CD6", "CD226", "LCK",
                   "VEGF", "TIGIT", "CDH1", "CD80")

par(mfrow=c(4,5), xpd = T)
netVisual_heatmap(Ctrl.7, measure = "weight", slot.name = "netP", signaling = pathways.show[1], color.heatmap = "Reds")
netVisual_heatmap(Ctrl.7, measure = "weight", slot.name = "netP", signaling = pathways.show[2], color.heatmap = "Reds")
netVisual_heatmap(Ctrl.7, measure = "weight", slot.name = "netP", signaling = pathways.show[3], color.heatmap = "Reds")
netVisual_heatmap(Ctrl.7, measure = "weight", slot.name = "netP", signaling = pathways.show[4], color.heatmap = "Reds")
netVisual_heatmap(Ctrl.7, measure = "weight", slot.name = "netP", signaling = pathways.show[5], color.heatmap = "Reds")
netVisual_heatmap(Ctrl.7, measure = "weight", slot.name = "netP", signaling = pathways.show[6], color.heatmap = "Reds")
netVisual_heatmap(Ctrl.7, measure = "weight", slot.name = "netP", signaling = pathways.show[7], color.heatmap = "Reds")
netVisual_heatmap(Ctrl.7, measure = "weight", slot.name = "netP", signaling = pathways.show[8], color.heatmap = "Reds")
netVisual_heatmap(Ctrl.7, measure = "weight", slot.name = "netP", signaling = pathways.show[9], color.heatmap = "Reds")
netVisual_heatmap(Ctrl.7, measure = "weight", slot.name = "netP", signaling = pathways.show[10], color.heatmap = "Reds")
netVisual_heatmap(Ctrl.7, measure = "weight", slot.name = "netP", signaling = pathways.show[11], color.heatmap = "Reds")
netVisual_heatmap(Ctrl.7, measure = "weight", slot.name = "netP", signaling = pathways.show[12], color.heatmap = "Reds")
netVisual_heatmap(Ctrl.7, measure = "weight", slot.name = "netP", signaling = pathways.show[13], color.heatmap = "Reds")
netVisual_heatmap(Ctrl.7, measure = "weight", slot.name = "netP", signaling = pathways.show[14], color.heatmap = "Reds")
netVisual_heatmap(Ctrl.7, measure = "weight", slot.name = "netP", signaling = pathways.show[15], color.heatmap = "Reds")
netVisual_heatmap(Ctrl.7, measure = "weight", slot.name = "netP", signaling = pathways.show[16], color.heatmap = "Reds")
netVisual_heatmap(Ctrl.7, measure = "weight", slot.name = "netP", signaling = pathways.show[17], color.heatmap = "Reds")
netVisual_heatmap(Ctrl.7, measure = "weight", slot.name = "netP", signaling = pathways.show[18], color.heatmap = "Reds")
netVisual_heatmap(Ctrl.7, measure = "weight", slot.name = "netP", signaling = pathways.show[19], color.heatmap = "Reds")
```

```{r pathway_net_agg, fig.dim = c(10,8), dpi = 300, echo = F}
par(mfrow=c(3,2))
netVisual_aggregate(Ctrl.7, signaling = pathways.show[1], layout = "circle")
netVisual_aggregate(Ctrl.7, signaling = pathways.show[2], layout = "circle")
netVisual_aggregate(Ctrl.7, signaling = pathways.show[3], layout = "circle")
netVisual_aggregate(Ctrl.7, signaling = pathways.show[4], layout = "circle")
netVisual_aggregate(Ctrl.7, signaling = pathways.show[5], layout = "circle")

par(mfrow=c(3,2))
netVisual_aggregate(Ctrl.7, signaling = pathways.show[6], layout = "circle")
netVisual_aggregate(Ctrl.7, signaling = pathways.show[7], layout = "circle")
netVisual_aggregate(Ctrl.7, signaling = pathways.show[8], layout = "circle")
netVisual_aggregate(Ctrl.7, signaling = pathways.show[9], layout = "circle")
netVisual_aggregate(Ctrl.7, signaling = pathways.show[10], layout = "circle")

par(mfrow=c(3,2))
netVisual_aggregate(Ctrl.7, signaling = pathways.show[11], layout = "circle")
netVisual_aggregate(Ctrl.7, signaling = pathways.show[12], layout = "circle")
netVisual_aggregate(Ctrl.7, signaling = pathways.show[13], layout = "circle")
netVisual_aggregate(Ctrl.7, signaling = pathways.show[14], layout = "circle")
netVisual_aggregate(Ctrl.7, signaling = pathways.show[15], layout = "circle")

par(mfrow=c(3,2))
netVisual_aggregate(Ctrl.7, signaling = pathways.show[16], layout = "circle")
netVisual_aggregate(Ctrl.7, signaling = pathways.show[17], layout = "circle")
netVisual_aggregate(Ctrl.7, signaling = pathways.show[18], layout = "circle")
netVisual_aggregate(Ctrl.7, signaling = pathways.show[19], layout = "circle")
```

```{r, echo = F}

pairLR <- list()
for(j in pathways.show)
  pairLR[[j]] <- extractEnrichedLR(Ctrl.7, signaling = j, geneLR.return = T)

par(mfrow=c(4,5), xpd = T)

netAnalysis_contribution(Ctrl.7, signaling = pathways.show[1], font.size = 6, title = paste0(pathways.show[1], " pathway LR contribution", collapse =''))
netAnalysis_contribution(Ctrl.7, signaling = pathways.show[2], font.size = 6, title = paste0(pathways.show[2], " pathway LR contribution", collapse =''))
netAnalysis_contribution(Ctrl.7, signaling = pathways.show[3], font.size = 6, title = paste0(pathways.show[3], " pathway LR contribution", collapse =''))
netAnalysis_contribution(Ctrl.7, signaling = pathways.show[4], font.size = 6, title = paste0(pathways.show[4], " pathway LR contribution", collapse =''))
netAnalysis_contribution(Ctrl.7, signaling = pathways.show[5], font.size = 6, title = paste0(pathways.show[5], " pathway LR contribution", collapse =''))

netAnalysis_contribution(Ctrl.7, signaling = pathways.show[6], font.size = 6, title = paste0(pathways.show[6], " pathway LR contribution", collapse =''))
netAnalysis_contribution(Ctrl.7, signaling = pathways.show[7], font.size = 6, title = paste0(pathways.show[7], " pathway LR contribution", collapse =''))
netAnalysis_contribution(Ctrl.7, signaling = pathways.show[8], font.size = 6, title = paste0(pathways.show[8], " pathway LR contribution", collapse =''))
netAnalysis_contribution(Ctrl.7, signaling = pathways.show[9], font.size = 6, title = paste0(pathways.show[9], " pathway LR contribution", collapse =''))
netAnalysis_contribution(Ctrl.7, signaling = pathways.show[10], font.size = 6, title = paste0(pathways.show[10], " pathway LR contribution", collapse =''))

netAnalysis_contribution(Ctrl.7, signaling = pathways.show[11], font.size = 6, title = paste0(pathways.show[11], " pathway LR contribution", collapse =''))
netAnalysis_contribution(Ctrl.7, signaling = pathways.show[12], font.size = 6, title = paste0(pathways.show[12], " pathway LR contribution", collapse =''))
netAnalysis_contribution(Ctrl.7, signaling = pathways.show[13], font.size = 6, title = paste0(pathways.show[13], " pathway LR contribution", collapse =''))
netAnalysis_contribution(Ctrl.7, signaling = pathways.show[14], font.size = 6, title = paste0(pathways.show[14], " pathway LR contribution", collapse =''))
netAnalysis_contribution(Ctrl.7, signaling = pathways.show[15], font.size = 6, title = paste0(pathways.show[15], " pathway LR contribution", collapse =''))

netAnalysis_contribution(Ctrl.7, signaling = pathways.show[16], font.size = 6, title = paste0(pathways.show[16], " pathway LR contribution", collapse =''))
netAnalysis_contribution(Ctrl.7, signaling = pathways.show[17], font.size = 6, title = paste0(pathways.show[17], " pathway LR contribution", collapse =''))
netAnalysis_contribution(Ctrl.7, signaling = pathways.show[18], font.size = 6, title = paste0(pathways.show[18], " pathway LR contribution", collapse =''))
netAnalysis_contribution(Ctrl.7, signaling = pathways.show[19], font.size = 6, title = paste0(pathways.show[19], " pathway LR contribution", collapse =''))
```

```{r LR_plots, fig.dim=c(10,8), dpi = 300, echo = F}

# pathways.show <- c("CCL", "ICAM", "ITGB2", "BAFF", "ADGRE5", 
#                    "TGFb", "CD22", "CD45", "IL16", "TNF", 
#                    "CXCL", "CD96", "CD6", "CD226", "LCK",
#                    "VEGF", "TIGIT", "CDH1", "CD80")
par(mfrow = c(length(pairLR),1))
for(i in pathways.show)
{
  par(mfrow = c(ceiling((nrow(pairLR[[i]]$pairLR)+1/5)),5))
  netAnalysis_contribution(Ctrl.7, signaling = i, font.size = 6, title = paste0(i, " pathway LR contribution", collapse =''))
  #par(mfrow = c(ceiling(nrow(pairLR[[i]]$pairLR)/5),5))
  print(paste0(i, " pathway LR pairs"))
  netVisual_individual(Ctrl.7, signaling = i,  pairLR.use = pairLR[[i]]$pairLR, layout = "circle")
}

```
